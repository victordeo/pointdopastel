<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Gestão</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles/output.css" />
</head>
<body class="bg-gray-100">
  <!-- Navbar -->
  <header class="w-full h-[65px] bg-banner bg-zinc-900 bg-cover bg-center mb-0 relative"></header>
  <nav class="relative bg-white shadow-md p-3 mb-2 flex items-center space-x-6 pl-[10.3%]">
    <div class="absolute top-0 left-0 w-1/12 flex justify-center -translate-y-10 mx-6">
      <img src="/assets/images/logo.png" class="w-24 h-24 object-contain" />
    </div>
    <div class="w-8/12 flex gap-2">
      <h1 class="text-red-600 font-semibold px-4 py-2 rounded">Painel de gestão</h1>
      <a href="#" class="text-gray-700 font-semibold px-4 py-2 rounded hover:bg-red-600 hover:text-white transition">Produtos</a>
      <a href="#" class="text-gray-700 font-semibold px-4 py-2 rounded hover:bg-red-600 hover:text-white transition">Pedidos</a>
      <a href="#" class="text-gray-700 font-semibold px-4 py-2 rounded hover:bg-red-600 hover:text-white transition">Relatórios</a>
      <a href="/pdv.html" class="text-gray-700 font-semibold px-4 py-2 rounded hover:bg-red-600 hover:text-white transition">Frente de caixa</a>
    </div>
  </nav>

  <!-- Conteúdo principal -->
  <main class="flex flex-col gap-6 px-6 pb-10">
    <!-- Início -->
    <section id="inicio" class="bg-white rounded shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Visão Geral</h2>
      <p class="text-gray-700">Bem-vindo ao painel de gestão! Aqui você pode acompanhar o desempenho do seu negócio.</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div class="bg-red-100 p-4 rounded text-center">
          <p class="text-sm text-gray-500">Vendas de hoje</p>
          <p class="text-2xl font-bold">R$ 0,00</p>
        </div>
        <div class="bg-yellow-100 p-4 rounded text-center">
          <p class="text-sm text-gray-500">Pedidos pendentes</p>
          <p class="text-2xl font-bold">0</p>
        </div>
        <div class="bg-green-100 p-4 rounded text-center">
          <p class="text-sm text-gray-500">Produtos ativos</p>
          <p class="text-2xl font-bold" id="produtos-ativos">0</p>
        </div>
      </div>
    </section>

    <!-- Produtos -->
    <section id="produtos" class="bg-white rounded shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Produtos</h2>
      <button id="btnNovoProduto" class="mb-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Novo Produto</button>
      <table class="w-full text-left">
        <thead>
          <tr class="text-gray-700 border-b">
            <th class="py-2">Categoria</th>
            <th class="py-2">Nome</th>
            <th class="py-2">Preço</th>
            <th class="py-2 text-center">Disponibilidade</th>
            <th class="py-2">Ações</th>
          </tr>
        </thead>
        <tbody>
          <!-- Produtos carregados dinamicamente aqui -->
        </tbody>
      </table>
    </section>

    <!-- Pedidos -->
    <section id="pedidos" class="bg-white rounded shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Pedidos Recentes</h2>
      <table class="w-full text-left">
        <thead>
          <tr class="text-gray-700 border-b">
            <th class="py-2">#ID</th>
            <th class="py-2">Cliente</th>
            <th class="py-2">Itens</th>
            <th class="py-2">Total</th>
            <th class="py-2">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b hover:bg-gray-50">
            <td class="py-2">#1023</td>
            <td class="py-2">João Silva</td>
            <td class="py-2">3</td>
            <td class="py-2">R$ 18,00</td>
            <td class="py-2 text-yellow-600">Em preparo</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Relatórios -->
    <section id="relatorios" class="bg-white rounded shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Relatórios</h2>
      <p class="text-gray-700 mb-2">Selecione o período:</p>
      <input type="date" class="border p-2 rounded mr-2" />
      <input type="date" class="border p-2 rounded" />
      <button class="ml-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Gerar</button>

      <div class="mt-6">
        <h3 class="text-lg font-semibold mb-2">Resumo</h3>
        <ul class="list-disc list-inside text-gray-700">
          <li>Pedidos: 125</li>
          <li>Faturamento: R$ 2.450,00</li>
          <li>Produtos mais vendidos: Pastel de Carne, Pastel de Queijo</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- Modal de Novo Produto -->
  <div id="modalProduto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4">Novo Produto</h3>
      <form id="formNovoProduto" class="space-y-4" enctype="multipart/form-data">
        <div>
          <label class="block text-sm font-medium text-gray-700">Nome</label>
          <input name="nome" type="text" class="w-full border rounded p-2" required />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Descrição</label>
          <textarea name="descricao" class="w-full border rounded p-2" rows="2"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Preço</label>
          <input name="preco" type="number" step="0.01" class="w-full border rounded p-2" required />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Categoria</label>
          <select name="categoria_id" id="selectCategoria" class="w-full border rounded p-2" required>
            <!-- Categorias serão carregadas aqui -->
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Imagem</label>
          <input name="imagem" type="file" accept="image/*" class="w-full" />
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium text-gray-700">Ativo</label>
          <input name="ativo" type="checkbox" />
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="btnCancelar" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
            Cancelar
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const btnNovoProduto = document.getElementById('btnNovoProduto');
    const modalProduto = document.getElementById('modalProduto');
    const btnCancelar = document.getElementById('btnCancelar');
    const form = document.getElementById('formNovoProduto');
    const tbodyProdutos = document.querySelector('#produtos tbody');
    const selectCategoria = document.getElementById('selectCategoria');
    const produtosAtivosCount = document.getElementById('produtos-ativos');

    // Abrir modal novo produto
    btnNovoProduto.addEventListener('click', () => {
      limparFormulario();
      modalProduto.classList.remove('hidden');
    });

    // Cancelar modal
    btnCancelar.addEventListener('click', () => {
      modalProduto.classList.add('hidden');
      limparFormulario();
    });

    // Fechar modal clicando fora
    modalProduto.addEventListener('click', (e) => {
      if (e.target === modalProduto) {
        modalProduto.classList.add('hidden');
        limparFormulario();
      }
    });

    // Limpa formulário e remove flag edição
    function limparFormulario() {
      form.reset();
      delete form.dataset.editando;
    }

    // Carregar categorias para select
    async function carregarCategorias() {
      try {
        const resp = await fetch('/api/categorias');
        if (!resp.ok) throw new Error('Erro ao carregar categorias');
        const categorias = await resp.json();

        selectCategoria.innerHTML = '';
        categorias.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.nome;
          selectCategoria.appendChild(option);
        });
      } catch (err) {
        alert(err.message);
      }
    }

    // Carregar produtos na tabela
    async function carregarProdutos() {
      try {
        const resp = await fetch('/api/produtos');
        if (!resp.ok) throw new Error('Erro ao carregar produtos');
        const produtos = await resp.json();

        tbodyProdutos.innerHTML = '';
        let ativos = 0;

        produtos.forEach(prod => {
          if (prod.ativo == 1) ativos++;

          const tr = document.createElement('tr');
          tr.className = 'border-b hover:bg-gray-50';

          tr.innerHTML = `
            <td class="py-2">${prod.categoria_nome || ''}</td>
            <td class="py-2">${prod.nome}</td>
            <td class="py-2">R$ ${parseFloat(prod.preco).toFixed(2).replace('.', ',')}</td>
            <td class="py-2 text-center">
              <input type="checkbox" disabled ${prod.ativo ? 'checked' : ''} />
            </td>
            <td class="py-2">
              <button class="text-blue-600 btn-editar" data-id="${prod.id}">Editar</button>
              <button class="text-red-600 ml-2 btn-excluir" data-id="${prod.id}">Excluir</button>
            </td>
          `;

          tbodyProdutos.appendChild(tr);
        });

        produtosAtivosCount.textContent = ativos;

        // Delegar eventos
        document.querySelectorAll('.btn-editar').forEach(btn => {
          btn.addEventListener('click', () => abrirModalEdicao(btn.dataset.id));
        });
        document.querySelectorAll('.btn-excluir').forEach(btn => {
          btn.addEventListener('click', () => excluirProduto(btn.dataset.id));
        });
      } catch (err) {
        alert(err.message);
        console.error(err);
      }
    }

    // Abrir modal para editar produto
    async function abrirModalEdicao(id) {
      try {
        const resp = await fetch('/api/produtos');
        if (!resp.ok) throw new Error('Erro ao buscar produtos');
        const produtos = await resp.json();
        const produto = produtos.find(p => p.id == id);
        if (!produto) throw new Error('Produto não encontrado');

        form.nome.value = produto.nome;
        form.descricao.value = produto.descricao || '';
        form.preco.value = produto.preco;
        form.categoria_id.value = produto.categoria_id;
        form.ativo.checked = produto.ativo == 1;

        form.dataset.editando = id;
        modalProduto.classList.remove('hidden');
      } catch (err) {
        alert(err.message);
      }
    }

    // Envio do formulário para criar ou editar produto
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      formData.set('ativo', form.ativo.checked ? '1' : '0');

      const idEditando = form.dataset.editando;
      let url = '/api/produtos';
      let method = 'POST';

      if (idEditando) {
        url += '/' + idEditando;
        method = 'PUT';
      }

      try {
        const resposta = await fetch(url, {
          method,
          body: formData,
        });

        if (!resposta.ok) throw new Error('Erro ao salvar produto');

        alert(idEditando ? 'Produto atualizado!' : 'Produto cadastrado!');
        modalProduto.classList.add('hidden');
        limparFormulario();
        carregarProdutos();
      } catch (err) {
        alert(err.message);
      }
    });

    // Excluir produto
    async function excluirProduto(id) {
      if (!confirm('Confirma exclusão do produto?')) return;

      try {
        const resp = await fetch('/api/produtos/' + id, { method: 'DELETE' });
        if (!resp.ok) throw new Error('Erro ao excluir produto');
        alert('Produto excluído!');
        carregarProdutos();
      } catch (err) {
        alert(err.message);
      }
    }

    // Inicialização
    window.addEventListener('DOMContentLoaded', () => {
      carregarCategorias();
      carregarProdutos();
    });
  </script>
</body>
</html>
